<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Museumâ€‘Grade Photo & Video UI â€” v1.10.4 (dropâ€‘box reorder & sequence index)</title>
<style>
  :root{
    --bg:#0f1115; --stroke:rgba(255,255,255,.18); --text:rgba(255,255,255,.88);
    --muted:rgba(255,255,255,.65); --radius:18px; --accent:#d7c29f;
    --gray:1; --blur:0px;
    --resize-ease: cubic-bezier(0.23, 1, 0.32, 1);
    --ctrl-scale: 1;
    --ctrl-bottom: 18px;
  }
  *{box-sizing:border-box}
  /* Invisible scrollbars */
  .stage, .caption-panel, .caption-text { scrollbar-width: none; -ms-overflow-style: none; }
  .stage::-webkit-scrollbar, .caption-panel::-webkit-scrollbar, .caption-text::-webkit-scrollbar { width: 0; height: 0; }

  body{
    margin:0; color:var(--text);
    font:15px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
    background:
      radial-gradient(1200px 800px at 70% 10%, rgba(215,194,159,.18), transparent 60%),
      radial-gradient(900px 600px at 10% 90%, rgba(255,240,220,.12), transparent 60%),
      linear-gradient(180deg,#0b0d12,#0f1115);
  }
  .wrap{display:grid;grid-template-columns:420px 1fr;gap:28px;min-height:100vh;padding:28px}
  .panel{padding:22px;border-radius:var(--radius);background:rgba(255,255,255,.05);border:1px solid var(--stroke);text-align:center}
  .panel h1{margin:0 0 10px;font-size:18px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:8px 0}
  .btn,.chip{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;user-select:none;text-decoration:none}
  .btn .dot,.chip .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 16px var(--accent)}
  .chip.active{background:rgba(215,194,159,.14);border-color:rgba(215,194,159,.5)}

  /* === Impression Dial === */
  .dial{
    --ring: rgba(255,255,255,.14);
    position:relative;
    width:var(--dial-size); height:var(--dial-size); margin:8px auto 6px;
    border-radius:50%;
    background:
      radial-gradient(120px 120px at 50% 50%, rgba(255,255,255,.06), rgba(255,255,255,.02) 60%, transparent 61%),
      conic-gradient(from 0deg, rgba(215,194,159,.25), rgba(215,194,159,.05) 120deg, rgba(255,255,255,.08) 240deg, rgba(215,194,159,.25) 360deg);
    border:1px solid var(--stroke);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 8px 26px rgba(0,0,0,.35);
    cursor:grab;
    user-select:none;
  }
  .dial.dragging{ cursor:grabbing; }
  .dial::after{ /* center hub */
    content:"";
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:16px; height:16px; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 35%, rgba(255,255,255,.06) 60%);
    border:1px solid rgba(255,255,255,.5);
    box-shadow:0 2px 10px rgba(0,0,0,.45);
  }
  .needle{
    --angle: 0deg;
    position:absolute; left:50%; top:50%;
    width:4px; height:42%;
    transform-origin:50% 100%;
    transform: translate(-50%, -100%) rotate(var(--angle));
    background: linear-gradient(to top, rgba(215,194,159,1), rgba(215,194,159,.15));
    border-radius:3px;
    box-shadow: 0 0 10px rgba(215,194,159,.55);
  }
  .label{ font-size:13px; color:var(--muted); margin:4px 0 10px; }

  .stage{position:relative;border-radius:var(--radius);border:1px solid var(--stroke);background:rgba(255,255,255,.02);display:flex;flex-direction:column;overflow:auto;max-height:calc(100vh - 56px)}
  .grid{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:18px;padding:18px;filter:grayscale(var(--gray)) blur(var(--blur))}
  @media (max-width:1200px){.grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}.panel{order:2}.stage{max-height:none}}

  .tile{position:relative;aspect-ratio:1/1;border-radius:16px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,.35);transition:transform .25s ease,box-shadow .25s ease,outline-color .25s;outline:1px solid rgba(255,255,255,.06)}
  .tile:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(0,0,0,.45);outline-color:rgba(255,255,255,.16)}
  .tile.size-2{grid-column:span 2;grid-row:span 2}
  .tile img,.tile video{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in;
  -webkit-user-drag: none;

  user-select: none;
}
  .tile video{filter:saturate(1.05)}
  /* Sequence badge */
  .seq-badge{position:absolute;left:8px;top:8px;min-width:22px;height:22px;border-radius:999px;display:none;place-items:center;font-size:12px;padding:0 6px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(6px)}
  /* Tools */
  .tools{position:absolute;inset:8px 8px auto auto;display:none;gap:8px;z-index:2}
  .tool{background:rgba(20,22,28,.6);border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .tool:hover{background:rgba(20,22,28,.8)}
  /* Editing state */
  body.editing .tile img, body.editing .tile video{cursor:default}
  body.editing .tile:hover .tools{display:flex}
  .tile.selected{outline:2px solid rgba(215,194,159,.85);box-shadow:0 12px 36px rgba(215,194,159,.25)}

  /* Floating drop box */
  .drop-box{
    position:fixed;
    pointer-events:none;
    border-radius:16px;
    border:2px dashed rgba(215,194,159,.9);
    box-shadow:0 0 0 2px rgba(215,194,159,.2), 0 12px 40px rgba(0,0,0,.45);
    transition: left .08s ease, top .08s ease, width .08s ease, height .08s ease, opacity .12s ease;
    opacity:0;
    z-index:150;
  }
  .drop-box.show{opacity:1}

  /* Lightbox */
  .lightbox{--caption-space-x:0px;--caption-space-y:0px;position:fixed;inset:0;display:grid;place-items:center;background:rgba(10,12,16,.72);backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:100;overflow:hidden}
  .lightbox.open{opacity:1;pointer-events:auto}
  .lb-shell{position:relative;display:flex;align-items:center;justify-content:center;gap:0;transform:translate(var(--shift-x,0),var(--shift-y,0));transition:transform .38s var(--resize-ease);will-change:transform}
  .media-wrap{position:relative}
  .lightbox .media{max-width:calc(min(86vw,1400px) - var(--caption-space-x));max-height:calc(86vh - var(--caption-space-y));border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.6);display:block;transition:max-width .32s var(--resize-ease),max-height .32s var(--resize-ease),filter .18s ease;will-change:max-width,max-height}
  #lbVideo{display:none;background:#000} #lbImage{display:block}
  .lightbox.show-video #lbVideo{display:block} .lightbox.show-video #lbImage{display:none}
  .lb-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.08);border:1px solid #ffffff;color:#ffffff;box-shadow:0 18px 40px rgba(0,0,0,.45);border-radius:999px;width:42px;height:42px;display:grid;place-items:center;cursor:pointer;z-index:5}
  .lb-prev{left:24px;} 
  .lb-next{right:24px;} 
  .lb-close{top:24px;right:24px;transform:none;width:40px;height:40px;}

  .controls{position:absolute;left:50%;bottom:var(--ctrl-bottom);transform:translateX(-50%) scale(var(--ctrl-scale));transform-origin:50% 100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.25);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:6;will-change:transform,bottom}
  .lightbox:not(.show-video) .controls{display:none !important}
  .controls.show{opacity:1;pointer-events:auto}
  .cbtn{appearance:none;border:0;cursor:pointer;border-radius:999px;height:34px;min-width:34px;padding:0 10px;display:grid;place-items:center;background:rgba(255,255,255,.1);color:#fff}
  .cbtn:hover{background:rgba(255,255,255,.18)}
  .ctime{min-width:92px;text-align:center;font-variant-numeric:tabular-nums}
  .seek{width:180px} .seek input[type=range]{width:100%}
  .vol{width:90px} .vol input[type=range]{width:100%}
  .cspeed{appearance:none;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:10px;padding:4px 8px}
  .loop.active{box-shadow:0 0 0 2px rgba(215,194,159,.6) inset}

  /* Caption panel */
  .caption-panel{position:absolute;top:0;left:100%;height:100%;width:min(28vw,380px);transform:translateX(12px);opacity:0;display:flex;flex-direction:column;gap:10px;background:linear-gradient(90deg,rgba(14,16,22,.0),rgba(14,16,22,.65));padding:18px 18px 18px 22px;transition:transform .32s var(--resize-ease),opacity .28s ease,width .2s ease,height .2s ease;border-top-right-radius:18px;border-bottom-right-radius:18px;z-index:4;pointer-events:none;overflow:auto}
  .caption-panel.visible,.caption-panel.pinned{transform:translateX(0);opacity:1;pointer-events:auto}
  .caption-head{display:flex;align-items:center;gap:10px}
  .caption-title{font-weight:700;opacity:.9;flex:1}
  .caption-meta{font-size:12px;color:var(--muted)}
  .caption-input,.caption-text{width:100%;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:10px 12px;backdrop-filter:blur(6px);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);transition:border-color .2s ease,box-shadow .2s ease,background .2s ease,height .2s var(--resize-ease)}
  .caption-input::placeholder,.caption-text::placeholder{color:var(--muted)}
  .caption-input:focus,.caption-text:focus{outline:none;color:#fff;border-color:rgba(215,194,159,.5);box-shadow:0 0 0 2px rgba(215,194,159,.25);background:rgba(255,255,255,.08)}
  .caption-input{height:40px;line-height:20px}
  .caption-text{resize:vertical;min-height:110px;max-height:50vh;overflow:auto}
  .caption-save{align-self:flex-start}
  .pin{appearance:none;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .pin.active{background:rgba(215,194,159,.22);border-color:rgba(215,194,159,.6)}

  .caption-handle{position:absolute;top:50%;right:0;transform:translate(100%,-50%);width:2px;height:60%;background:linear-gradient(180deg,rgba(215,194,159,.0),rgba(215,194,159,.85),rgba(215,194,159,.0));border-radius:2px;z-index:6;opacity:.6;pointer-events:none}
  .caption-hit{position:absolute;left:var(--hit-left,0px);top:var(--hit-top,0px);height:var(--hit-height,0px);width:var(--hit-width,40px);z-index:3;pointer-events:auto;background:transparent}

  .lightbox.mode-bottom .caption-panel{top:100%;left:0;width:100%;height:auto;transform:translateY(12px);padding:14px 18px 18px;background:linear-gradient(180deg,rgba(14,16,22,.0),rgba(14,16,22,.65));border-top-right-radius:0;border-bottom-right-radius:18px;border-bottom-left-radius:18px;border-top-left-radius:0}
  .lightbox.mode-bottom .caption-panel.visible,.lightbox.mode-bottom .caption-panel.pinned{transform:translateY(0)}
  .lightbox.mode-bottom .caption-handle{top:auto;right:auto;bottom:0;left:50%;width:60%;height:2px;transform:translate(-50%,100%);background:linear-gradient(90deg,rgba(215,194,159,.0),rgba(215,194,159,.85),rgba(215,194,159,.0))}

  .drop-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:200}
  .drop-overlay.show{display:grid}
  .drop-card{padding:18px 22px;border-radius:14px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;text-align:center}
  .drop-card small{display:block;opacity:.7;margin-top:6px}

  /* ===== Responsive control panel layout ===== */
  :root { --dial-size: 180px; }

  .panel-controls{
    display:grid;
    gap:16px;
    align-items:center;
  }
  .controls-dial{ display:grid; justify-items:center; gap:6px; }
  .controls-actions{ display:grid; gap:10px; }

  /* Landscape (horizontal aspect ratio): stack vertically */
  @media (orientation: landscape){
    .panel-controls{ grid-template-columns: 1fr; }
    :root{ --dial-size: clamp(140px, 18vw, 200px); }
    .controls-dial{ justify-self:center; }
  }

  /* Portrait (vertical aspect ratio): dial left, actions right */
  @media (orientation: portrait){
    .panel-controls{ grid-template-columns: minmax(180px, 38%) 1fr; align-items:start; }
    :root{ --dial-size: clamp(160px, 26vh, 240px); }
    .controls-dial{ align-self:start; }
  }

  /* Tidy rows inside actions column */
  .controls-actions .row{
    display:grid;
    grid-template-columns: 120px 1fr;
    align-items:center;
    gap:12px;
    padding:4px 0;
    text-align:left;
  }


  /* === Lightbox chrome: contrast + auto-hide on media hover === */
  .lb-btn{
    background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.35));
    border: 1.6px solid rgba(255,255,255,.92);
    color:#fff;
    backdrop-filter: blur(4px);
    box-shadow: 0 18px 40px rgba(0,0,0,.5);
    filter: drop-shadow(0 4px 12px rgba(0,0,0,.45));
    text-shadow: 0 1px 6px rgba(0,0,0,.65), 0 0 0.5px rgba(255,255,255,.35);
  }
  .lb-btn.ah{ opacity:0; pointer-events:none; transition:opacity .18s ease; }
  /* Show only when cursor is over the media area */
  .lightbox.media-hover .lb-btn.ah{ opacity:1; pointer-events:auto; }


  /* Show when media or chrome are hovered */
  .lightbox.media-hover .lb-btn.ah,
  .lightbox.ui-on .lb-btn.ah{ opacity:1; pointer-events:auto; }


  body.editing .seq-badge{ display:grid; }

</style>
</head>
<body>
  <div class="wrap">
    <section class="panel">
  <h1>Impression Controls</h1>
  <div class="panel-controls">
    <div class="controls-dial">
      <div class="dial" id="dial"><div class="needle" id="needle"></div></div>
      <div class="label"><span id="moodLabel">Impression â€¢ 0% (Greyscale)</span></div>
    </div>
    <div class="controls-actions">
      <div class="row">
        <label>Uploads</label>
        <label class="btn" for="fileInput"><span class="dot"></span> Upload media</label>
        <input id="fileInput" type="file" accept="image/*,video/*" multiple hidden>
      </div>
      <div class="row">
        <label>Edit</label>
        <div id="editToggle" class="chip"><span class="dot"></span> Edit mode</div>
      </div>
      <div class="row">
        <label>Playback</label>
        <div id="autoPlayToggle" class="chip"><span class="dot"></span> Auto Play</div>
      </div>
    </div>
  </div>
</section>

    <section class="stage" id="stage">
      <div class="grid" id="grid">
        <!-- Seed tiles -->
        <div class="tile"><span class="seq-badge">0</span><div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div><img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="tile"><span class="seq-badge">1</span><div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div><img src="https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="tile"><span class="seq-badge">2</span><div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div><img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="tile"><span class="seq-badge">3</span><div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div><img src="https://images.unsplash.com/photo-1482192596544-9eb780fc7f66?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="tile"><span class="seq-badge">4</span><div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div><img src="https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop" alt=""></div>
        <div class="tile"><span class="seq-badge">5</span><div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div><img src="https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=1200&auto=format&fit=crop" alt=""></div>
      </div>

      <!-- Lightbox -->
      <div class="lightbox" id="lightbox" aria-hidden="true">
        <div class="lb-shell" id="lbShell">
          <button class="lb-btn lb-close ah" id="lbClose" aria-label="Close">âœ•</button>
          <button class="lb-btn lb-prev ah" id="lbPrev" aria-label="Previous">â€¹</button>

          <div class="media-wrap" id="mediaWrap">
            <img id="lbImage" class="media" alt="Expanded media" />
            <video id="lbVideo" class="media" playsinline muted loop></video>

            <!-- Bottom-Centered Controls (video-only) -->
            <div class="controls" id="controls">
              <button class="cbtn" id="cPrev" title="Previous (â†)">âŸ¨</button>
              <button class="cbtn" id="cBack" title="Back 5s">âˆ’5s</button>
              <button class="cbtn" id="cPlay" title="Play/Pause">â–º</button>
              <button class="cbtn" id="cFwd" title="Forward 5s">+5s</button>
              <span class="ctime" id="cTime">00:00 / 00:00</span>
              <div class="seek"><input id="cSeek" type="range" min="0" max="1000" value="0"></div>
              <button class="cbtn" id="cMute" title="Mute (M)">ðŸ”‡</button>
              <div class="vol"><input id="cVol" type="range" min="0" max="1" step="0.02" value="1"></div>
              <select id="cSpeed" class="cspeed" title="Speed">
                <option>0.5Ã—</option><option>0.75Ã—</option><option selected>1Ã—</option><option>1.25Ã—</option><option>1.5Ã—</option><option>2Ã—</option>
              </select>
              <button class="cbtn loop" id="cLoop" title="Loop">âˆž</button>
              <button class="cbtn" id="cNext" title="Next (â†’)">âŸ©</button>
            </div>

            <div class="caption-handle" id="captionHandle" title="Show caption"></div>

            <div class="caption-panel" id="captionPanel">
              <div class="caption-head">
                <div class="caption-title">Caption</div>
                <button id="captionPin" class="pin" title="Pin panel">Pin</button>
              </div>
              <div class="caption-meta" id="captionMeta">â€”</div>
              <input id="captionTitle" class="caption-input" placeholder="Title (optional)" />
              <textarea id="captionText" class="caption-text" placeholder="Write notes or a description..."></textarea>
              <button class="btn caption-save" id="captionSave"><span class="dot"></span> Save</button>
            </div>
          </div>

          <div class="caption-hit" id="captionHit" aria-hidden="true"></div>

          <button class="lb-btn lb-next ah" id="lbNext" aria-label="Next">â€º</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Global drop overlay -->
  <div class="drop-overlay" id="dropOverlay">
    <div class="drop-card">
      Drop images or videos to add
      <small>Files from your computer, or image/video links</small>
    </div>
  </div>

  <!-- Floating drop box element -->
  <div class="drop-box" id="dropBox" aria-hidden="true"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== Dial =====
  const dial = document.getElementById('dial');
  const needle = document.getElementById('needle');
  const moodLabel = document.getElementById('moodLabel');
  function setCSS(v,val){ document.documentElement.style.setProperty(v,val); }
  function applyMoodFromAngle(a){
    needle.style.setProperty('--angle', a+'deg');
    const p=(a%360)/360, gray=(1-p);
    setCSS('--gray', gray.toFixed(3));
    moodLabel.textContent = p===0 ? 'Impression â€¢ 0% (Greyscale)' : p===1 ? 'Impression â€¢ 100% (Full Color)' : `Impression â€¢ ${Math.round(p*100)}%`;
  }
  function angleFromEvent(e){
    const r=dial.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    const p=e.touches?e.touches[0]:e;
    return (Math.atan2(p.clientY-cy,p.clientX-cx)*180/Math.PI+90+360)%360;
  }
  const dialState={dragging:false};
  dial.addEventListener('mousedown',e=>{ dialState.dragging=true; dial.classList.add('dragging'); applyMoodFromAngle(angleFromEvent(e)); e.preventDefault?.(); });
  window.addEventListener('mousemove',e=>{ if(!dialState.dragging) return; applyMoodFromAngle(angleFromEvent(e)); });
  window.addEventListener('mouseup',()=>{ dialState.dragging=false; dial.classList.remove('dragging'); });
  dial.addEventListener('touchstart',e=>{ dialState.dragging=true; dial.classList.add('dragging'); applyMoodFromAngle(angleFromEvent(e)); },{passive:true});
  window.addEventListener('touchmove',e=>{ if(!dialState.dragging) return; applyMoodFromAngle(angleFromEvent(e)); },{passive:true});
  window.addEventListener('touchend',()=>{ dialState.dragging=false; dial.classList.remove('dragging'); });
  applyMoodFromAngle(0);

  // ===== Core refs =====
  const grid   = document.getElementById('grid');
  // Prevent native image/video drag; only our drop-box should move.
  grid.addEventListener('dragstart', (e)=>{
    if (e.target && (e.target.closest && e.target.closest('.tile img, .tile video'))) {
      e.preventDefault();
    }
  });
  function markUndraggable(root){
    if(!root) return;
    const list = root.matches ? (root.matches('.tile img, .tile video') ? [root] : []) : [];
    const nodes = [...(root.querySelectorAll ? root.querySelectorAll('.tile img, .tile video') : []), ...list];
    nodes.forEach(n=>{ try{ n.draggable = false; }catch(_){} });
  }
  // Initial pass
  markUndraggable(document);
  // Observe future additions inside the grid
  const _dragGuardObserver = new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes && m.addedNodes.forEach(n=>{
        if(n.nodeType === 1) markUndraggable(n);
      });
    });
  });
  _dragGuardObserver.observe(grid, {childList:true, subtree:true});

  const stage  = document.getElementById('stage');
  const editToggle = document.getElementById('editToggle');
  const autoPlayToggle = document.getElementById('autoPlayToggle');
  const dropOverlay=document.getElementById('dropOverlay');
  const dropBox = document.getElementById('dropBox');

  // ===== Edit mode gating =====
  let editing=false;
  function setEditMode(on){
    editing=!!on;
    document.body.classList.toggle('editing',editing);
    if(!editing) clearSelection();
    dropOverlay.classList.remove('show'); dragDepth=0;
    refreshMedia();
  }
  editToggle.addEventListener('click',()=>{ editToggle.classList.toggle('active'); setEditMode(editToggle.classList.contains('active')); });

  // ===== Tile tools =====
  function bindTileTools(tile){
    tile.querySelector('.tool-del').addEventListener('click',e=>{ e.stopPropagation(); tile.remove(); refreshMedia(); updateSequenceIndices(); });
    tile.querySelector('.tool-s1').addEventListener('click',e=>{ e.stopPropagation(); tile.classList.remove('size-2'); });
    tile.querySelector('.tool-s2').addEventListener('click',e=>{ e.stopPropagation(); tile.classList.add('size-2'); });
  }

  // ===== Selection + drop-box reorder =====
  let selectedTile = null;
  let currentDropTarget = null;
  let dragging = false;
  let pointerId = null;

  
  let longPressTimer = null;
  const HOLD_DELAY_MS = 220;
function clearSelection(){
    if(selectedTile){ selectedTile.classList.remove('selected'); selectedTile = null; }
    hideDropBox();
    currentDropTarget = null;
    dragging=false; pointerId=null;
  }

  grid.addEventListener('click', (e)=>{
    if(!editing) return;
    const tile = e.target.closest('.tile');
    if(!tile) return;
    selectTile(tile);
  });

  function selectTile(tile){
    if(selectedTile === tile) return;
    if(selectedTile) selectedTile.classList.remove('selected');
    selectedTile = tile;
    selectedTile.classList.add('selected');
  }

  
grid.addEventListener('pointerdown', (e)=>{
    if(!editing) return;
    const tile = e.target.closest('.tile');
    if(!tile) return;
    // left-click only
    if (typeof e.button !== 'undefined' && e.button !== 0) return;

    // Select but don't start drag yet (simple clicks should not trigger drop box)
    selectTile(tile);

    // Clear any previous timer
    if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }

    // Start long-press to activate drag + drop box
    longPressTimer = setTimeout(()=>{
      // Still holding?
      if (e.buttons !== undefined && (e.buttons & 1) === 0) return;

      dragging = true;
      pointerId = e.pointerId;
      e.target.setPointerCapture?.(pointerId);
      showDropBoxForTile(tile);
    }, HOLD_DELAY_MS);
});

grid.addEventListener('pointermove', (e)=>{
    if(!dragging || !editing) return;
    const el = document.elementFromPoint(e.clientX, e.clientY);
    const hit = el ? el.closest('.tile') : null;
    if(hit && hit.parentElement === grid){
      currentDropTarget = hit;
      showDropBoxForTile(hit);
      autoScrollIfNeeded(e.clientX, e.clientY);
    }
  });

  function tileIndex(t){ return [...grid.querySelectorAll('.tile')].indexOf(t); }

  
window.addEventListener('pointercancel', (e)=>{
    if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
    if (dragging) { dragging = false; }
});
window.addEventListener('pointerup', (e)=>{
    
    if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
if(!dragging) return;
    dragging=false;
    const target = currentDropTarget;
    if(target && selectedTile && target !== selectedTile){
      const from = tileIndex(selectedTile);
      const to   = tileIndex(target);
      if(from < 0 || to < 0) { hideDropBox(); return; }
      // Insert after when moving forward; before when moving backward
      if(from < to) grid.insertBefore(selectedTile, target.nextSibling);
      else grid.insertBefore(selectedTile, target);
      updateSequenceIndices();
    }
    hideDropBox();
  });

  function showDropBoxForTile(tile){
    const r = tile.getBoundingClientRect();
    dropBox.style.left = Math.round(r.left) + 'px';
    dropBox.style.top = Math.round(r.top) + 'px';
    dropBox.style.width = Math.round(r.width) + 'px';
    dropBox.style.height = Math.round(r.height) + 'px';
    dropBox.classList.add('show');
  }
  function hideDropBox(){
    dropBox.classList.remove('show');
  }

  function autoScrollIfNeeded(x, y){
    const sr = stage.getBoundingClientRect();
    const Z = 60, SPEED = 20;
    if(y < sr.top + Z) stage.scrollTop -= SPEED;
    else if(y > sr.bottom - Z) stage.scrollTop += SPEED;
    if(x < sr.left + Z) stage.scrollLeft -= SPEED;
    else if(x > sr.right - Z) stage.scrollLeft += SPEED;
  }

  function updateSequenceIndices(){
    const tiles = [...grid.querySelectorAll('.tile')];
    tiles.forEach((t,i)=>{
      t.dataset.seq = i;
      let b = t.querySelector('.seq-badge');
      if(!b){ b = document.createElement('span'); b.className='seq-badge'; t.appendChild(b); }
      b.textContent = i;
    });
    refreshMedia();
  }

  // ===== Lightbox & Controls =====
  const lb=document.getElementById('lightbox');
  const lbImg=document.getElementById('lbImage');
  const lbVideo=document.getElementById('lbVideo');
  const lbClose=document.getElementById('lbClose');
  const lbPrev=document.getElementById('lbPrev');
  const lbNext=document.getElementById('lbNext');
  const lbShell=document.getElementById('lbShell');
  const mediaWrap=document.getElementById('mediaWrap');
  const controls=document.getElementById('controls');

  const cPrev=document.getElementById('cPrev');
  const cNext=document.getElementById('cNext');
  const cBack=document.getElementById('cBack');
  const cFwd=document.getElementById('cFwd');
  const cPlay=document.getElementById('cPlay');
  const cTime=document.getElementById('cTime');
  const cSeek=document.getElementById('cSeek');
  const cMute=document.getElementById('cMute');
  const cVol=document.getElementById('cVol');
  const cSpeed=document.getElementById('cSpeed');
  const cLoop=document.getElementById('cLoop');

  const captionHandle=document.getElementById('captionHandle');
  const captionPanel=document.getElementById('captionPanel');
  const captionMeta=document.getElementById('captionMeta');
  const captionTitle=document.getElementById('captionTitle');
  const captionText=document.getElementById('captionText');
  const captionSave=document.getElementById('captionSave');
  const captionPin=document.getElementById('captionPin');
  const captionHit=document.getElementById('captionHit');

  function fmt(t){ if(!isFinite(t)) return '00:00'; const m=Math.floor(t/60), s=Math.floor(t%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function updateTimeUI(){
    const d=lbVideo.duration||0, ct=lbVideo.currentTime||0;
    cTime.textContent = `${fmt(ct)} / ${fmt(d)}`;
    cSeek.value = d? Math.round(ct/d*1000) : 0;
  }
  function applyCaptionFor(src, meta=''){
    const saved = captions.get(src) || {title:'', text:''};
    captionTitle.value = saved.title;
    captionText.value = saved.text;
    captionMeta.textContent = meta;
  }
  function saveCaptionFor(src){
    captions.set(src,{title:captionTitle.value.trim(), text:captionText.value.trim()});
  }

  function isPortrait(){ return window.innerHeight > window.innerWidth; }
  function setCaptionSpace(x, y){ lb.style.setProperty('--caption-space-x', (x||0) + 'px'); lb.style.setProperty('--caption-space-y', (y||0) + 'px'); }
  function updateOrientationClass(){ lb.classList.toggle('mode-bottom', isPortrait()); lb.classList.toggle('mode-right', !isPortrait()); }

  const CAP_GAP = 12;
  let rafId = 0, pendingX = 0, pendingY = 0;
  function scheduleSpaceUpdate(x, y){
    pendingX = x||0; pendingY = y||0;
    if(rafId) return;
    rafId = requestAnimationFrame(()=>{
      setCaptionSpace(pendingX, pendingY);
      applyComboShift();
      updateCaptionHitZone();
      fitControls();
      rafId = 0;
    });
  }

  function measureAndSetCaptionSpace(){
    if(!(captionPanel.classList.contains('visible') || captionPanel.classList.contains('pinned'))){
      captionPanel.style.height = isPortrait() ? 'auto' : '100%';
      scheduleSpaceUpdate(0,0); return;
    }
    if(isPortrait()){
      captionPanel.style.height = 'auto';
      const natural = Math.ceil(captionPanel.scrollHeight);
      const minH = Math.round(Math.min(Math.max(window.innerHeight * 0.22, 160), 340));
      const maxH = Math.floor(window.innerHeight * 0.86) - 24;
      const panelH = Math.max(minH, Math.min(natural, Math.max(180, maxH)));
      captionPanel.style.height = panelH + 'px';
      scheduleSpaceUpdate(0, Math.ceil(panelH + CAP_GAP));
    }else{
      const desired = Math.min(Math.max(window.innerWidth * 0.22, 220), 380);
      captionPanel.style.width = Math.round(desired) + 'px';
      const r = captionPanel.getBoundingClientRect();
      scheduleSpaceUpdate(Math.ceil(r.width + CAP_GAP), 0);
    }
  }

  function applyComboShift(){
    const hasCaption = captionPanel.classList.contains('visible') || captionPanel.classList.contains('pinned');
    let sx = 0, sy = 0;
    if(hasCaption){
      if(isPortrait()){
        sy = -Math.round((pendingY||0)/2);
      } else {
        sx = -Math.round((pendingX||0)/2);
      }
    }
    lbShell.style.setProperty('--shift-x', sx + 'px');
    lbShell.style.setProperty('--shift-y', sy + 'px');
  }

  function onResize(){ updateOrientationClass(); measureAndSetCaptionSpace(); trackDuringTransition(600); }
  window.addEventListener('resize', onResize);

  function trackDuringTransition(duration=420){
    const start = performance.now();
    function tick(now){
      updateCaptionHitZone();
      fitControls();
      if(now - start < duration) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // Lightbox media switching (order-aware)
  let idx=0, media=[], captionPinned=false;
  const captions = new Map();

  function computeMediaList(){ return [...grid.querySelectorAll('.tile img,.tile video')]; }
  function showInLightbox(node){
    updateOrientationClass();
    if(!captionPinned) captionPanel.classList.remove('visible');
    if(node.tagName.toLowerCase()==='video'){
      lb.classList.add('show-video');
      lbVideo.src=node.currentSrc||node.src; lbVideo.currentTime=0;
      lbVideo.play().catch(()=>{});
      cPlay.textContent='âšâš';
    } else {
      lb.classList.remove('show-video');
      lbImg.src=node.currentSrc||node.src;
      cPlay.textContent='â–º';
      controls.classList.remove('show');
    }
    const meta = node.tagName.toLowerCase()==='video'
      ? 'Video â€¢ ' + (node.videoWidth||'') + 'Ã—' + (node.videoHeight||'')
      : 'Image';
    applyCaptionFor(node.currentSrc||node.src, meta);
    captionPanel.classList.toggle('pinned', captionPinned);
    measureAndSetCaptionSpace();
    updateCaptionHitZone();
    applyComboShift();
    trackDuringTransition(600);
  }
  function openLB(i){ media = computeMediaList(); if(media[i]){ idx=i; showInLightbox(media[idx]); lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); } }
  function closeLB(){ lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); lbVideo.pause(); }
  function step(d){ media = computeMediaList(); if(!media.length) return; idx=(idx+d+media.length)%media.length; showInLightbox(media[idx]); }

  document.getElementById('lbClose').addEventListener('click',closeLB);
  document.getElementById('lbPrev').addEventListener('click',()=>step(-1));
  document.getElementById('lbNext').addEventListener('click',()=>step(1));
  lb.addEventListener('click',e=>{ if(e.target===lb) closeLB(); });

  // Grid click: open lightbox only when not editing
  grid.addEventListener('click', (e)=>{
    if(editing) return;
    const el = e.target.closest('.tile img, .tile video');
    if(!el) return;
    const list = computeMediaList();
    const i = list.indexOf(el);
    if(i>-1) openLB(i);
  });

  // Keyboard shortcuts guarded
  function isTypingTarget(el){
    if(!el) return false;
    const tag = el.tagName ? el.tagName.toLowerCase() : '';
    return tag === 'input' || tag === 'textarea' || el.isContentEditable;
  }
  window.addEventListener('keydown',e=>{
    if(!lb.classList.contains('open')) return;
    if(isTypingTarget(e.target) || isTypingTarget(document.activeElement)) return;
    if(e.key==='Escape') closeLB();
    else if(e.key==='ArrowLeft') step(-1);
    else if(e.key==='ArrowRight') step(1);
    else if(e.key===' '){ e.preventDefault(); togglePlay(); }
    else if(e.key.toLowerCase()==='m'){ toggleMute(); }
  });

  // Controls
  function togglePlay(){
    if(!lb.classList.contains('show-video')) return;
    if(lbVideo.paused){ lbVideo.play(); cPlay.textContent='âšâš'; }
    else { lbVideo.pause(); cPlay.textContent='â–º'; }
  }
  function toggleMute(){ if(!lb.classList.contains('show-video')) return; lbVideo.muted=!lbVideo.muted; cMute.textContent = lbVideo.muted ? 'ðŸ”‡' : 'ðŸ”ˆ'; }
  cPlay.addEventListener('click',togglePlay);
  cBack.addEventListener('click',()=>{ if(!lb.classList.contains('show-video')) return; lbVideo.currentTime=Math.max(0,lbVideo.currentTime-5); });
  cFwd .addEventListener('click',()=>{ if(!lb.classList.contains('show-video')) return; lbVideo.currentTime=Math.min(lbVideo.duration||0,lbVideo.currentTime+5); });
  cPrev.addEventListener('click',()=>step(-1));
  cNext.addEventListener('click',()=>step(1));
  cSeek.addEventListener('input',e=>{ if(!lb.classList.contains('show-video')) return; const d=lbVideo.duration||0; lbVideo.currentTime = d*(e.target.value/1000); });
  cMute.addEventListener('click',toggleMute);
  cVol .addEventListener('input',e=>{ if(!lb.classList.contains('show-video')) return; lbVideo.volume = +e.target.value; lbVideo.muted = (lbVideo.volume===0); });
  cSpeed.addEventListener('change',e=>{ if(!lb.classList.contains('show-video')) return; lbVideo.playbackRate = parseFloat(e.target.value.replace('Ã—','')) || 1; });
  cLoop.addEventListener('click',()=>{ if(!lb.classList.contains('show-video')) return; lbVideo.loop=!lbVideo.loop; cLoop.classList.toggle('active', lbVideo.loop); });

  lbVideo.addEventListener('timeupdate',updateTimeUI);
  lbVideo.addEventListener('loadedmetadata',()=>{ updateTimeUI(); fitControls(); });

  // Auto-hide controls
  let hideTimer=null;
  function showControls(){
    if(!lb.classList.contains('show-video')) return;
    controls.classList.add('show');
    if(hideTimer) clearTimeout(hideTimer);
    hideTimer=setTimeout(()=>controls.classList.remove('show'), 1600);
    fitControls();
  }
  function hideControls(){ controls.classList.remove('show'); if(hideTimer) clearTimeout(hideTimer); }
  mediaWrap.addEventListener('mousemove', showControls);
  mediaWrap.addEventListener('mouseenter', showControls);
  mediaWrap.addEventListener('mouseleave', hideControls);

  // Fit & position transport controls
  function fitControls(){
    if(!lb.classList.contains('show-video')) return;
    const wrap = mediaWrap.getBoundingClientRect();
    controls.style.setProperty('--ctrl-scale', 1);
    controls.style.setProperty('--ctrl-bottom', '18px');
    const naturalWidth = controls.scrollWidth;
    const naturalHeight = controls.scrollHeight;

    const margin = 24;
    const maxWidth = Math.max(80, wrap.width - margin);
    const scaleW = maxWidth / naturalWidth;

    const maxHeight = Math.max(60, wrap.height - margin);
    const scaleH = maxHeight / naturalHeight;

    let scale = Math.min(1, scaleW, scaleH);
    scale = Math.max(0.65, scale);

    const bottom = wrap.height < (naturalHeight * scale + 24) ? 6 : 18;

    controls.style.setProperty('--ctrl-scale', scale.toFixed(3));
    controls.style.setProperty('--ctrl-bottom', bottom + 'px');
  }

  // ===== Caption reveal/hide & pin =====
  let revealTimer=null, hideIntentTimer=null;

  function revealCaption(){
    if(revealTimer){ clearTimeout(revealTimer); revealTimer=null; }
    if(!captionPinned){
      revealTimer=setTimeout(()=>{
        captionPanel.classList.add('visible');
        measureAndSetCaptionSpace();
        applyComboShift();
        trackDuringTransition(480);
      },80);
    }
  }
  function concealCaption(){
    if(revealTimer){ clearTimeout(revealTimer); revealTimer=null; }
    if(!captionPinned){
      if(hideIntentTimer){ clearTimeout(hideIntentTimer); }
      hideIntentTimer=setTimeout(()=>{
        captionPanel.classList.remove('visible');
        measureAndSetCaptionSpace();
        applyComboShift();
        trackDuringTransition(420);
      },120);
    }
  }
  captionHit.addEventListener('mouseenter', revealCaption);
  captionHit.addEventListener('mouseleave', concealCaption);
  captionHandle.addEventListener('mouseenter', revealCaption);
  captionHandle.addEventListener('mouseleave', concealCaption);
  captionPanel.addEventListener('mouseenter', ()=>{ if(hideIntentTimer){ clearTimeout(hideIntentTimer); } });
  captionPanel.addEventListener('mouseleave', concealCaption);

  captionPin.addEventListener('click',()=>{
    captionPinned = !captionPinned;
    captionPin.classList.toggle('active', captionPinned);
    captionPanel.classList.toggle('pinned', captionPinned);
    if(!captionPinned){ captionPanel.classList.remove('visible'); } else { captionPanel.classList.add('visible'); }
    measureAndSetCaptionSpace();
    applyComboShift();
    trackDuringTransition(600);
  });

  captionSave.addEventListener('click',()=>{
    const node = computeMediaList()[idx];
    if(!node) return;
    const key = node.currentSrc||node.src;
    saveCaptionFor(key);
    captionSave.classList.add('chip','active');
    setTimeout(()=>captionSave.classList.remove('active'), 600);
  });

  // ===== Uploads =====
  const fileInput=document.getElementById('fileInput');
  fileInput.addEventListener('change',e=>{ handleFiles(e.target.files); e.target.value=''; });

  function appendTile(tile){
    // Assign next sequence immediately
    const nextSeq = grid.querySelectorAll('.tile').length;
    tile.dataset.seq = nextSeq;
    let b = tile.querySelector('.seq-badge');
    if(!b){ b = document.createElement('span'); b.className='seq-badge'; tile.appendChild(b); }
    b.textContent = nextSeq;
    grid.appendChild(tile);
    bindTileTools(tile);
  }

  function addImageFromURL(url){
    const tile=document.createElement('div'); tile.className='tile';
    tile.innerHTML='<div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div>';
    const img=document.createElement('img'); img.src=url; img.alt='';
    tile.appendChild(img); appendTile(tile);
  }
  function addVideoFromURL(url){
    const tile=document.createElement('div'); tile.className='tile';
    tile.innerHTML='<div class="tools"><button class="tool tool-del" title="Remove">âœ•</button><button class="tool tool-s1" title="Small">S</button><button class="tool tool-s2" title="Large">L</button></div>';
    const vid=document.createElement('video');
    vid.src=url; vid.muted=true; vid.loop=true; vid.playsInline=true; vid.preload='metadata';
    tile.appendChild(vid); appendTile(tile);
  }
  function handleFiles(files){
    if(!files || !files.length) return;
    [...files].forEach(f=>{
      const url=URL.createObjectURL(f);
      if(f.type.startsWith('image/')) addImageFromURL(url);
      else if(f.type.startsWith('video/')) addVideoFromURL(url);
    });
    updateSequenceIndices(); // final authoritative refresh
    refreshMedia();
  }
  function inferKindFromURL(url){
    const u = (url||'').split('?')[0].split('#')[0].toLowerCase();
    const imgExt = ['.jpg','.jpeg','.png','.gif','.webp','.avif','.bmp'];
    const vidExt = ['.mp4','.webm','.mov','.m4v','.ogg','.ogv'];
    if(imgExt.some(ext=>u.endsWith(ext))) return 'image';
    if(vidExt.some(ext=>u.endsWith(ext))) return 'video';
    return null;
  }
  function handleURLs(text){
    if(!text) return;
    const parts = text.split(/\s+/).filter(Boolean);
    parts.forEach(u=>{
      try{
        const url = new URL(u).href;
        const kind = inferKindFromURL(url);
        if(kind==='image') addImageFromURL(url);
        else if(kind==='video') addVideoFromURL(url);
      }catch(_){}
    });
    updateSequenceIndices();
    refreshMedia();
  }

  // ===== External Drag & Drop (only when NOT editing) =====
  function isFileOrUrlDrag(e){
    const dt = e.dataTransfer;
    if(!dt) return false;
    const types = Array.from(dt.types||[]);
    return types.includes('Files') || types.includes('text/uri-list') || types.includes('text/plain');
  }
  let dragDepth = 0;
  window.addEventListener('dragenter', e=>{
    if(editing) return;
    if(isFileOrUrlDrag(e)){
      dragDepth++;
      dropOverlay.classList.add('show');
      e.preventDefault();
    }
  });
  window.addEventListener('dragover', e=>{
    if(editing) return;
    if(isFileOrUrlDrag(e)){
      e.preventDefault();
    }
  });
  window.addEventListener('dragleave', e=>{
    if(editing) return;
    if(isFileOrUrlDrag(e)){
      dragDepth = Math.max(0, dragDepth - 1);
      if(dragDepth===0) dropOverlay.classList.remove('show');
    }
  });
  window.addEventListener('drop', e=>{
    if(editing) return;
    if(isFileOrUrlDrag(e)){
      e.preventDefault();
      dropOverlay.classList.remove('show');
      dragDepth = 0;
      const dt = e.dataTransfer;
      if(dt && dt.files && dt.files.length){
        handleFiles(dt.files);
      } else if(dt){
        const urlList = dt.getData('text/uri-list') || dt.getData('text/plain');
        handleURLs(urlList);
      }
    }
  });

  // ===== Caption hit zone to canvas edges =====
  function updateCaptionHitZone(){
    const lbRect = lb.getBoundingClientRect();
    const shellRect = lbShell.getBoundingClientRect();
    const mediaRect = mediaWrap.getBoundingClientRect();
    let left=0, top=0, width=0, height=0;
    if(isPortrait()){
      left   = Math.max(0, Math.round(mediaRect.left - shellRect.left));
      top    = Math.max(0, Math.round(mediaRect.bottom - shellRect.top));
      width  = Math.max(0, Math.round(mediaRect.width));
      height = Math.max(0, Math.round(lbRect.bottom - mediaRect.bottom));
    }else{
      left   = Math.max(0, Math.round(mediaRect.right - shellRect.left));
      top    = Math.max(0, Math.round(mediaRect.top - shellRect.top));
      height = Math.max(0, Math.round(mediaRect.height));
      width  = Math.max(0, Math.round(lbRect.right - mediaRect.right));
    }
    lbShell.style.setProperty('--hit-left',  left + 'px');
    lbShell.style.setProperty('--hit-top',   top + 'px');
    lbShell.style.setProperty('--hit-height',height + 'px');
    lbShell.style.setProperty('--hit-width', width + 'px');
  }

  // ===== Autoplay viewport =====
  let autoPlayEnabled = false;
  let io = null;
  autoPlayToggle.addEventListener('click', ()=>{ autoPlayEnabled = !autoPlayEnabled; updateAutoplay(); });
  function getAllVideos(){ return [...document.querySelectorAll('.tile video')]; }
  function ensureObserver(){
    if(io) io.disconnect();
    if(!autoPlayEnabled) return;
    io = new IntersectionObserver(entries=>{
      entries.forEach(({target,isIntersecting})=>{
        if(!autoPlayEnabled) { try{ target.pause(); }catch(_){ } return; }
        if(isIntersecting){ target.play().catch(()=>{}); } else { try{ target.pause(); }catch(_){} }
      });
    }, { root: stage, threshold: 0.5 });
    getAllVideos().forEach(v=>io.observe(v));
  }
  function updateAutoplay(){
    autoPlayToggle.classList.toggle('active', autoPlayEnabled);
    if(!autoPlayEnabled){ getAllVideos().forEach(v=>{ try{ v.pause(); }catch(_){ } }); }
    ensureObserver();
  }

  function refreshMedia(){
    ensureObserver();
  }

  // Init
  [...grid.querySelectorAll('.tile')].forEach(bindTileTools);
  updateSequenceIndices();
});

  // === Lightbox chrome hover manager (prevents flicker, keeps buttons clickable) ===
(function(){
  const lbEl = document.getElementById('lightbox');
  const wrapEl = document.getElementById('mediaWrap');
  if(!lbEl || !wrapEl) return;
  const btns = Array.from(lbEl.querySelectorAll('.lb-btn'));

  let hideTimer = null;
  const HIDE_DELAY = 220; // small hysteresis to avoid blinking at edges

  function showUI(){
    lbEl.classList.add('ui-on');
    if(hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
  }
  function scheduleHide(){
    if(hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(()=>{
      // Only hide if neither media nor any button are hovered
      const overMedia = wrapEl.matches(':hover');
      const overBtn = btns.some(b=>b.matches(':hover'));
      if(!overMedia && !overBtn){
        lbEl.classList.remove('ui-on');
      }
    }, HIDE_DELAY);
  }

  // Media hover
  wrapEl.addEventListener('mouseenter', showUI);
  wrapEl.addEventListener('mousemove', showUI);
  wrapEl.addEventListener('mouseleave', scheduleHide);

  // Buttons hover: keep visible while on them
  btns.forEach(b=>{
    b.addEventListener('mouseenter', showUI);
    b.addEventListener('mousemove', showUI);
    b.addEventListener('mouseleave', scheduleHide);
  });

  // Defensive: if the pointer moves inside the lightbox, re-check target
  lbEl.addEventListener('mousemove', e=>{
    const t = e.target;
    if (wrapEl.contains(t) || t.closest('.lb-btn')) showUI();
  });
})();</script>
</body>
</html>
